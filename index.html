<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>


<div class="tripdiary">
    <img src="img/top3.png" alt="ãã¾ã“ã®æ—…è¡Œè¨˜ã‚¿ã‚¤ãƒˆãƒ«" class="imgtrip"> 
</div>

<div class="mapg">
<!-- ãƒ¡ãƒ¢é¢¨ã®äºŒæœ¬ç·š -->

<div class="main-container">
<div id="diary-list" style="display: none;"></div>
<div id="diary-detail" style="display: none;"></div>

<div class="topbutton">
    <button type="menu">æ–°è¦ä½œæˆ</button>
    <button type="menu">æ—¥è¨˜ä¸€è¦§</button>
    <button type="menu">æ‰€è¦æ™‚é–“</button>
    <!-- <button type="menu">ãŠæ°—ã«å…¥ã‚Š</button>     -->

</div>

<div class="double-line-deco">
</div>

<div class="form">
        <img src="img/hikouki.png" alt="é£›è¡Œæ©Ÿã®å†™çœŸ" class="imghikouki">


    <div class="form-top">
        <div class="form-block">
            <div class="formtitle"><label for="hiduke">æ—¥ä»˜</label></div>
            <input type="date" name="hiduke" class="formcontent-hiduke">    
        </div>

        <div class="form-block">
            <div class="formtitle"><label for="spot">è¡Œãå…ˆ</label></div>
            <input type="text" name="spot" class="formcontent-spot">    
        </div>
    </div>

    <div class="formtitle"><label for="kanso">æ„Ÿæƒ³</label></div>
    <textarea name="kanso" class="formcontent-kanso" rows="4"></textarea>

    <div class="form-memo-photo-schedule">
        
        <div class="form-left">

            <div class="memo">
                <div class="formtitle"><label for="memo">ãƒ¡ãƒ¢</label></div>
                <textarea name="memo" class="formcontent-memo" rows="4"></textarea>
            </div>
            <img src="img/car2.png" alt="è»Šã®å†™çœŸ" class="imgcar">

            <div class="photo">
                <div class="formtitle"><label for="photoInput">ç”»åƒ</label></div>
              
                <label class="custom-file-upload">
                  <input type="file" id="photoInput" accept="image/*" />
                  ç”»åƒã‚’é¸ã¶
                </label>
                <img id="previewImage" class="preview-img" />

              </div>
              
        </div>

        <div class="form-right">

            <div class="formtitle"><label for="schedule">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</label></div>
            
            <div class="schedule">

            <div class="schedule-row">
                <input type="time">
                <input type="text" name="schedule1" class="formcontent-schedule1">
            </div>
            <div class="schedule-row">
                <input type="time" >
                <input type="text" name="schedule2" class="formcontent-schedule2">
            </div>
            <div class="schedule-row">
                <input type="time" name="schedule3" class="formcontent-schedule3">
                <input type="text" name="schedule3" class="formcontent-schedule3">
            </div>
            <div class="schedule-row">
                <input type="time" name="schedule4" class="formcontent-schedule4">
                <input type="text" name="schedule4" class="formcontent-schedule4">
            </div>
            <div class="schedule-row">
                <input type="time" name="schedule5" class="formcontent-schedule5">
                <input type="text" name="schedule5" class="formcontent-schedule5">
            </div>
            <div class="schedule-row">
                <input type="time" name="schedule6" class="formcontent-schedule6">
                <input type="text" name="schedule6" class="formcontent-schedule6">
            </div>

            </div>
        </div>
    </div>

</div>

<!-- æ—…ç¨‹ã‚’ç«‹ã¦ã‚‹ãƒšãƒ¼ã‚¸ã®å†…å®¹ -->
<div id="route-form" style="display: none;">
<!-- æœ€åˆã¯éè¡¨ç¤ºã®çŠ¶æ…‹ã«ã—ã¦ãŠã -->
  <div id="route-map" class="route-map">
  </div>

  <div class="mapbox">
    <div class="mapset">
  <label for="origin" class="maptext">å‡ºç™ºåœ°</label><br>
  <input id="origin" type="text" class="kensaku" placeholder=""><br><br>
</div>

  <div class="mapbox">
  <label for="destination" class="maptext">åˆ°ç€åœ°</label><br>
  <input id="destination" type="text" class="kensaku" placeholder=""><br><br>
</div>
</div>
  <button id="searchRouteBtn" class="searchRouteBtn" >ãƒ«ãƒ¼ãƒˆæ¤œç´¢</button>

  <div id="directions-panel" style="margin-top:20px;"></div>


</div>

<button type="submit">
    ä¿å­˜
</button>
<div id="commentList"></div>
<div>
</div>

</div>

</div>

<!-- åœ°å›³ã‚¢ãƒ—ãƒªAPIèª­ã¿è¾¼ã¿ãƒ» -->
<script src="https://maps.googleapis.com/maps/api/js?key=&libraries=places">








// APIã‚­ãƒ¼ã¯éè¡¨ç¤ºï¼ï¼ï¼








</script>



<script>
    let diaryList = [];
    let selectedImage = "";

document.getElementById('photoInput').addEventListener('change', function () {
  const file = this.files[0];
  const reader = new FileReader();
  reader.onload = function (e) {
    document.getElementById('previewImage').src = e.target.result;
    selectedImage = e.target.result; // Base64æ–‡å­—åˆ—ã‚’ä¿å­˜
  };
  if (file) {
    reader.readAsDataURL(file);
  }
});


    //  ä¿å­˜å‡¦ç†
    document.querySelector('button[type="submit"]').addEventListener('click', () => {
  const date = document.querySelector('input[name="hiduke"]').value;
  const spot = document.querySelector('input[name="spot"]').value;
  const kanso = document.querySelector('textarea[name="kanso"]').value;
  const memo = document.querySelector('textarea[name="memo"]').value;


  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—
  const scheduleRows = document.querySelectorAll('.schedule-row');
  const schedule = [];
  scheduleRows.forEach(row => {
    const time = row.querySelector('input[type="time"]').value;
    const text = row.querySelector('input[type="text"]').value;
    if (time || text) {
      schedule.push({ time, text });
    }
  });

  if (!date || !spot) {
    alert("æ—¥ä»˜ã¨è¡Œãå…ˆã‚’å…¥åŠ›ã—ã¦ã­ï¼");
    return;
  }

  const diary = {
    id: Date.now(),
    date,
    spot,
    kanso,
    memo,
    schedule,
    image: selectedImage,
  };

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    let diaries = JSON.parse(localStorage.getItem("diaryList")) || [];
    diaryList.push(diary);
  localStorage.setItem("diaryList", JSON.stringify(diaryList));
 alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
  clearForm();

  showDiaries(); // è¡¨ç¤ºæ›´æ–°


  selectedImage = "";
document.getElementById('photoInput').value = ""; // inputè‡ªä½“ã‚’ã‚¯ãƒªã‚¢
document.getElementById('previewImage').src = ""; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚éè¡¨ç¤ºã«

});

    // åˆæœŸèª­ã¿è¾¼ã¿
    window.addEventListener('load', () => {
      const stored = localStorage.getItem("diaryList");
      if (stored) {
        diaryList = JSON.parse(stored);
      }
    });
  
    // æ—¥è¨˜ä¸€è¦§è¡¨ç¤º
    document.querySelectorAll('button[type="menu"]')[1].addEventListener('click', () => {
      const listDiv = document.getElementById('diary-list');
      // listDiv.innerHTML = `<h2 style="color: #9f6700;">æ—¥è¨˜ä¸€è¦§</h2>`;
  
diaryList.forEach(diary => {
  const entry = document.createElement('div');
  entry.style.display = "flex";
  entry.style.justifyContent = "space-between";
  entry.style.alignItems = "center";
  entry.style.marginBottom = "10px";
  entry.style.borderBottom = "1px solid #ccc";
  entry.style.padding = "5px 0";

  const info = document.createElement('span');
  info.textContent = `${diary.date} - ${diary.spot}`;
  info.style.cursor = "pointer";
  info.style.color = "#9f6700";
  info.addEventListener('click', () => showDiary(diary.id));

  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = "å‰Šé™¤";
  deleteBtn.style.background = "#c0392b";
  deleteBtn.style.color = "white";
  deleteBtn.style.border = "none";
  deleteBtn.style.borderRadius = "5px";
  deleteBtn.style.padding = "5px 10px";
  deleteBtn.style.cursor = "pointer";
  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // è©³ç´°è¡¨ç¤ºã‚’é˜²ã
    deleteDiary(diary.id);
  });

  entry.appendChild(info);
  entry.appendChild(deleteBtn);
  listDiv.appendChild(entry);

  document.querySelector('.form').style.display = "none";
  document.getElementById('diary-detail').style.display = "none";
  document.getElementById('route-form').style.display = "none"; // æ‰€è¦æ™‚é–“ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º



});
  
      listDiv.style.display = "block";
      document.querySelector('.form').style.display = "none";
      document.getElementById('diary-detail').style.display = "none";
    });
  
    // æ—¥è¨˜è©³ç´°è¡¨ç¤º
    function showDiary(id) {
  const diary = diaryList.find(d => d.id === id);
  const detailDiv = document.getElementById('diary-detail');

  detailDiv.innerHTML = `
    <div style="color: #9f6700;">
      <h2>${diary.date} - ${diary.spot}</h2>
      <p><strong>æ„Ÿæƒ³:</strong> ${diary.kanso}</p>
      <p><strong>ãƒ¡ãƒ¢:</strong> ${diary.memo}</p>
      <p><strong>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:</strong></p>
      <ul>
        ${diary.schedule.map(s => `<li>${s.time} - ${s.text}</li>`).join("")}
      </ul>
      
      ${
        diary.image
          ? `<p><strong>å†™çœŸ:</strong><br><img src="${diary.image}" style="max-width: 300px; border: 1px solid #ccc;" /></p>`
          : ''
      }

      <div id="comment-section">
        <h4>ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
        <div id="comments-list"></div>
        <textarea id="comment-input" rows="2" style="width:100%;"></textarea>
        <button id="submit-comment" class=submit-content>ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡</button>
        

      </div>


      <button class="button-style" onclick="backToList()">æˆ»ã‚‹</button>
    </div>
  `;
  detailDiv.style.display = "block";
  document.getElementById('diary-list').style.display = "none";



  // é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  document.getElementById('submit-comment').addEventListener('click', () => {
  const text = document.getElementById('comment-input').value.trim();
  if (text) {
    postComment(id, text);
    document.getElementById('comment-input').value = "";
  }
});

    const commentInput = document.getElementById('comment-input');
    commentInput.style.width = "100%";
    commentInput.style.border = "2px solid #9f6700";
    commentInput.style.borderRadius = "5px";
    commentInput.style.padding = "8px";
    commentInput.style.color = "#9f6700";
    commentInput.style.fontSize = "14px";
    commentInput.style.backgroundColor = "#fffaf0";
    commentInput.style.boxSizing = "border-box";
    commentInput.style.backgroundColor = "white";

 

loadComments(id);
// console.log("loadCommentsé–‹å§‹", diaryId);

// ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿è¡¨ç¤º

}

  
    // ä¸€è¦§ã«æˆ»ã‚‹
    function backToList() {
      document.getElementById('diary-detail').style.display = "none";
      document.getElementById('diary-list').style.display = "block";
    }
  
    // æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ï¼ˆæœ€åˆã®ç”»é¢ã«æˆ»ã™ï¼‰
    document.querySelectorAll('button[type="menu"]')[0].addEventListener('click', () => {
      clearForm();
      document.querySelector('.form').style.display = "block";
      document.getElementById('diary-list').style.display = "none";
      document.getElementById('diary-detail').style.display = "none";
        // æ‰€è¦æ™‚é–“ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«
      document.getElementById('route-form').style.display = "none";
      document.querySelector('button[type="submit"]').style.display = "inline-block"; // ä¿å­˜ãƒœã‚¿ãƒ³å¾©æ´»

    });
  
    // ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸåŒ–
    function clearForm() {
      document.querySelector('input[name="hiduke"]').value = "";
      document.querySelector('input[name="spot"]').value = "";
      document.querySelector('textarea[name="kanso"]').value = "";
      document.querySelector('textarea[name="memo"]').value = "";
    }

    document.querySelectorAll('button[type="menu"]')[2].addEventListener('click', () => {
  document.getElementById('route-form').style.display = "block";
  document.querySelector('.form').style.display = "none";
  document.getElementById('diary-list').style.display = "none";
  document.getElementById('diary-detail').style.display = "none";
  document.querySelector('button[type="submit"]').style.display = "none";

});

    
    function deleteDiary(id) {
  if (!confirm("ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰å‡¦ç†ã—ãªã„
  }

  // diaryListã‹ã‚‰è©²å½“IDã®æ—¥è¨˜ã‚’é™¤å¤–
  diaryList = diaryList.filter(diary => diary.id !== id);
  // localStorageã«ã‚‚ä¿å­˜ã—ç›´ã™
  localStorage.setItem("diaryList", JSON.stringify(diaryList));
  // ä¸€è¦§ã‚’å†è¡¨ç¤º
  document.querySelectorAll('button[type="menu"]')[1].click();
}


  </script>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved }
            from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
        // Your web app's Firebase configuration
        const firebaseConfig = {






// ã“ã“ã¯éè¡¨ç¤ºã«ã™ã‚‹ï¼ï¼ï¼ï¼





};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); //RealtimeDBã«æ¥ç¶š
        const dbRef = ref(db, "chat"); //RealtimeDBå†…ã®"chat"ã‚’ä½¿ã†

        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        window.postComment = function(diaryId, text) {
  const commentRef = ref(db, `comments/${diaryId}`);
  const newCommentRef = push(commentRef);
  set(newCommentRef, {
    text,
    createdAt: Date.now()
  });
};

  // ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ãƒ»è¡¨ç¤º
  window.loadComments = function(diaryId) {
  const commentRef = ref(db, `comments/${diaryId}`);
  const commentList = document.getElementById('comments-list');
  commentList.innerHTML = "";

  onChildAdded(commentRef, (data) => {
    const comment = data.val();
    const key = data.key;

    // ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´ ã‚’ä½œæˆ
    const p = document.createElement('div');
    p.className = "comment-block";
    p.dataset.key = key;

    const date = new Date(comment.createdAt).toLocaleString();
    const textSpan = document.createElement('span');
    textSpan.textContent = `ğŸ» ${date}: ${comment.text}`;

    // ç·¨é›†ãƒœã‚¿ãƒ³
    const editBtn = document.createElement('button');
    editBtn.textContent = "ç·¨é›†";
    editBtn.style.marginLeft = "10px";
    editBtn.style.marginBottom = "5px";
    editBtn.style.backgroundColor = "#2980b9";
    editBtn.style.color = "white";
    editBtn.style.border = "none";
    editBtn.style.padding = "2px 8px";
    editBtn.style.borderRadius = "3px";
    editBtn.style.cursor = "pointer";

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = "å‰Šé™¤";
    deleteBtn.style.marginLeft = "5px";
    deleteBtn.style.marginBottom = "5px";
    deleteBtn.style.backgroundColor = "#c0392b";
    deleteBtn.style.color = "white";
    deleteBtn.style.border = "none";
    deleteBtn.style.padding = "2px 8px";
    deleteBtn.style.borderRadius = "3px";
    deleteBtn.style.cursor = "pointer";

    // ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆ
    editBtn.addEventListener('click', () => {

      document.getElementById('comment-input').style.display = "none";
      document.getElementById('submit-comment').style.display = "none";


      // å…¥åŠ›æ¬„ã‚’ä½œæˆ
      const textarea = document.createElement('textarea');
      textarea.value = comment.text;
      textarea.rows = 2;
      textarea.style.width = "100%";    
      textarea.style.border = "2px solid #9f6700" ;    
      textarea.style.color = "#9f6700";     
      textarea.style.borderRadius = "5px";   
      textarea.style.fontSize = "14px";


      const saveBtn = document.createElement('button');
      saveBtn.textContent = "ä¿å­˜";
      saveBtn.style.margin = "0px 0px 5px 0px";
      saveBtn.style.backgroundColor = "#27ae60";
      saveBtn.style.color = "white";
      saveBtn.style.border = "none";
      saveBtn.style.padding = "8px 16px";
      saveBtn.style.borderRadius = "5px";
      saveBtn.style.cursor = "pointer";
      saveBtn.style.fontSize = "14px";

      // è¦ç´ ç½®ãæ›ãˆ
      p.innerHTML = "";
      p.appendChild(textarea);
      p.appendChild(saveBtn);

      // ä¿å­˜å‡¦ç†
      saveBtn.addEventListener('click', () => {
        const newText = textarea.value.trim();
        if (newText) {
          const updateRef = ref(db, `comments/${diaryId}/${key}`);
          set(updateRef, {
            text: newText,
            createdAt: Date.now() // æ—¥ä»˜ã‚‚æ›´æ–°
          });
          // æŠ•ç¨¿æ¬„ã‚’å†è¡¨ç¤º
          document.getElementById('comment-input').style.display = "block";
          document.getElementById('submit-comment').style.display = "inline-block";



    }
  });

    });
    

    // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
    deleteBtn.addEventListener('click', () => {
      if (confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        const delRef = ref(db, `comments/${diaryId}/${key}`);
        remove(delRef);
      }
    });

    p.appendChild(textSpan);
    p.appendChild(editBtn);
    p.appendChild(deleteBtn);
    commentList.appendChild(p);
  });

  // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤æ™‚ã«ç”»é¢ã‹ã‚‰ã‚‚å‰Šé™¤
  onChildRemoved(commentRef, (data) => {
    const removedKey = data.key;
    const target = document.querySelector(`.comment-block[data-key="${removedKey}"]`);
    if (target) {
      target.remove();
    }
  });
};


window.initMap = initMap;

    </script>






<!-- Google MapåˆæœŸåŒ–ç”¨ã®é–¢æ•°ã¯ type="module" ã®å¤–ã«ç½®ã -->
<script>
  function initRouteMap() {
    routeMap = new google.maps.Map(document.getElementById("route-map"), {
      center: {  lat: 35.6895, lng: 139.6917 },
      zoom: 12,
    });
  
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(routeMap);
    directionsRenderer.setPanel(document.getElementById("directions-panel"));
  
    let mode = "origin";
    let originMarker = null;
    let destinationMarker = null;
  
    routeMap.addListener("click", (e) => {
      const latLng = e.latLng;
  
      if (mode === "origin") {
        if (originMarker) originMarker.setMap(null);
        originMarker = new google.maps.Marker({ position: latLng, map: routeMap, label: "å‡º" });
        document.getElementById("origin").value = `${latLng.lat()},${latLng.lng()}`;
        mode = "destination";
      } else {
        if (destinationMarker) destinationMarker.setMap(null);
        destinationMarker = new google.maps.Marker({ position: latLng, map: routeMap, label: "ç€" });
        document.getElementById("destination").value = `${latLng.lat()},${latLng.lng()}`;
        mode = "origin";
      }
    });


    document.getElementById("searchRouteBtn").addEventListener("click", () => {
    const origin = document.getElementById("origin").value;
    const destination = document.getElementById("destination").value;

    if (!origin || !destination) {
      alert("å‡ºç™ºåœ°ã¨åˆ°ç€åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    directionsService.route(
      {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.WALKING,
      },
      (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);

          const duration = result.routes[0].legs[0].duration.text;
          document.getElementById("directions-panel").insertAdjacentHTML(
            "beforeend",
            `<p><strong>æ‰€è¦æ™‚é–“:</strong> ${duration}</p>`
          );
        } else {
          alert("ãƒ«ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + status);
        }
      }
    );
  });

  }

  
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åœ°å›³ã‚’åˆæœŸåŒ–
  window.addEventListener("load", () => {
    initRouteMap();
  });
  </script>


</body>
</html>